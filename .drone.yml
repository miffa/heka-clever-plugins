image: clever/drone-go:1.7
services:
- postgres
publish:
  report_card: {}
notify:
  email:
    recipients:
    - drone@clever.com
  slack:
    on_failure: true
    on_started: false
    on_success: false
    webhook_url: $$slack_webhook
script:
# Run tests for Go postgres library
- createdb -h localhost -U postgres drone
- psql -U postgres -h localhost -c "CREATE TABLE \"mock_table\" (s text, i int)" drone
- pushd postgres
- go get ./...
- go get github.com/stretchr/testify/assert
- go test
- popd

# Run tests for lua Plugins
- make lua-tests
